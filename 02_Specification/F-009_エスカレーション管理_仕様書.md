# F-009 エスカレーション管理 仕様書

## 1. 概要

* **ドキュメント名**：F-009 エスカレーション管理 仕様書
* **対象機能**：判定サポートロジックからエスカレーション推奨を受けた案件について、理由・添付・期限を設定しバックオフィスへ送付する UI/連携
* **対応する機能要件**：業務要件 P-009、機能要件 F-009
* **担当者**：Reporting QA フロントエンド＆CRM連携チーム
* **前提条件**：
  - F-007 の判定結果で `decision=no` またはオペレーター判断
  - バックオフィス受領チーム/ユーザーのマスタが整備済み
  - 添付資料（帳票/追資料）がストレージに保存済み
* **制約条件**：
  - 理由コード必須、かつ SLA 24 時間以内の期日設定必須
  - 送信後の内容編集は不可（差分はコメント追記で管理）
  - 監査のため添付/理由/担当者を `escalation` テーブルに保存

---

## 2. 画面仕様

### 2.1 概要

* **画面ID**：ESC-001
* **画面名称**：エスカレーション起票
* **利用者ロール**：コンタクトセンター／営業店 エスカレーション担当

### 2.2 レイアウト

```
上：案件概要（顧客/問い合わせ/AI判定）
中：理由コード選択＋自由記述、添付一覧
下：担当部署割当、期日、送信/ドラフトボタン
右：SLAタイマー、履歴
```

### 2.3 項目一覧

| 項目ID | 項目名 | 型 | 必須 | 備考 |
| ------ | ------ | -- | ---- | ---- |
| ITM-401 | 理由コード | select | ○ | マスタ5種程度 |
| ITM-402 | 詳細説明 | textarea | ○ | 1000文字 |
| ITM-403 | 添付ファイル | file list | △ | PDF/画像 |
| ITM-404 | 担当部署 | select | ○ | バックオフィス部門 |
| ITM-405 | 担当者 | select | △ | 任意 |
| ITM-406 | 期日 | date | ○ | 当日含む24h以内 |
| ITM-407 | 追加コメント | textarea | △ | 内部共有 |

### 2.4 アクション

| ID | 名称 | 処理 |
| -- | ---- | ---- |
| ACT-401 | エスカレーション送信 | CRM 調査依頼チケットを作成、`escalation` テーブル更新 |
| ACT-402 | ドラフト保存 | 入力内容を `escalation_draft` に保存 |
| ACT-403 | 添付追加 | ストレージへアップロードし URI を紐付け |

### 2.5 エラー

| No | メッセージ | 条件 |
| -- | ---------- | ---- |
| ERR-070 | 理由コードを選択してください。 | 未選択 |
| ERR-071 | 期日は24時間以内で設定してください。 | 期限違反 |
| ERR-072 | CRM連携に失敗しました。 | APIエラー |

---

## 3. 処理仕様

### 3.1 フロー

1. F-006 から案件情報・判定理由を読み込み
2. 入力値バリデーション
3. 添付アップロード（必要時）
4. CRM へ調査依頼チケット作成（S-001）
5. `escalation` テーブルへ登録
6. バックオフィスへ通知

### 3.2 詳細

| 手順 | 入力 | 出力 | 備考 |
| ---- | ---- | ---- | ---- |
| 1 | inquiry_id | case data | AI判定理由含む |
| 2 | form data | validation result | |
| 3 | files | storage URIs | 署名URL |
| 4 | payload | crm_ticket_id | API-ESC-01 |
| 5 | payload + crm_ticket_id | escalation record | DB |
| 6 | record | notification | Teams/メール |

### 3.3 業務ルール

* 理由コード＋自由記述の両方必須
* 添付には AI 出力＋顧客質問を自動添付
* 担当部署/担当者ごとの SLA タイマーを表示

### 3.4 例外処理

* CRM API 失敗時はローカルドラフトへ保存し、再送コマンドを提示
* 添付アップロード失敗は個別リトライ
* バックオフィス通知失敗はメールでフォールバック

---

## 4. API / 外部システム連携

| API ID | 名称 | 説明 |
| ------ | ---- | ---- |
| API-ESC-01 | CRM調査依頼登録API | REST、本画面→S-001 |
| API-NOT-01 | 通知Webhook | REST、本画面→Teams/メール |

**リクエスト例（CRM）**

```json
{
  "ticket_type": "investigation",
  "inquiry_id": "UUID",
  "reason_code": "lack_of_evidence",
  "description": "...",
  "attachments": [{"uri": "s3://..."}],
  "due_date": "2025-11-21T09:00:00+09:00"
}
```

---

## 5. データ仕様

* `escalation` テーブル（`05_テーブル定義`）に `assigned_to`, `due_date`, `status`
* `escalation_attachment`：`escalation_id`, `file_name`, `file_uri`, `uploaded_by`

---

## 6. シーケンス図

```
オペレーター →[エスカレーション入力]→ ESC-001
ESC-001 →[添付アップロード]→ ストレージ
ESC-001 →[POST調査依頼]→ CRM
CRM →[ticket_id]→ ESC-001
ESC-001 →[INSERT]→ DB(escalation)
ESC-001 →[通知]→ バックオフィス
```

