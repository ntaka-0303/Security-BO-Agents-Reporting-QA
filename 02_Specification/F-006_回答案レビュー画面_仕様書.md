# F-006 回答案レビュー画面 仕様書

## 1. 概要

* **ドキュメント名**：F-006 回答案レビュー画面 仕様書
* **対象機能**：AI 出力（回答案・根拠・オペメモ）をレビューし、編集・追質問・バージョン管理を行う UI
* **対応する機能要件**：業務要件 P-006、機能要件 F-006
* **担当者**：Reporting QA フロントエンドチーム
* **前提条件**：
  - F-005 から最新の `ai_response` レコードが配信済み
  - オペレーターがレビュー権限を有する
  - ベクトルストアの根拠リンクへアクセス可能
* **制約条件**：
  - バージョン履歴は最新 10 件まで（古いものはアーカイブ）
  - 追質問送信は 30 分以内に限定
  - レビュー実績は監査ログへ送出

---

## 2. 画面仕様

### 2.1 画面概要

* **画面ID**：AIN-002
* **画面名称**：回答案レビュー
* **利用者ロール**：レビュー担当（コンタクトセンター／営業店）

### 2.2 レイアウト

```
左：回答案エディタ（差分表示）
右上：根拠ビューア（ページプレビュー＋ハイライト）
右中：オペレーターメモ／コメント
下：バージョンタイムライン、アクションボタン
```

### 2.3 画面項目一覧

| 項目ID | 項目名 | 型 | 必須 | 備考 |
| ------ | ------ | -- | ---- | ---- |
| ITM-201 | 回答案エディタ | rich text | ○ | Markdown対応 |
| ITM-202 | 根拠ハイライト | viewer | ○ | ページ＋抜粋表示 |
| ITM-203 | コメント欄 | textarea | △ | 1000文字 |
| ITM-204 | バージョンタイムライン | list | ○ | version_no/作成者 |
| ITM-205 | 差分プレビュー | diff viewer | △ | 2版比較 |
| ITM-206 | 判定ステータス | badge | ○ | pending/承認等 |

### 2.4 アクション

| アクションID | 名称 | 処理概要 |
| ------------ | ---- | -------- |
| ACT-201 | 保存 | 編集内容を `ai_response` 新バージョンとして保存 |
| ACT-202 | 差分比較 | 選択した 2 バージョンの差分を表示 |
| ACT-203 | 追質問送信 | コメントを添えて F-005 へ再質問 |
| ACT-204 | ロールバック | 過去バージョンを現行として復元 |

### 2.5 エラーメッセージ

| No | メッセージ | 条件 |
| -- | ---------- | ---- |
| ERR-050 | 回答案が空です。 | エディタ未入力で保存 |
| ERR-051 | 追質問は 30 分以内に送信してください。 | 制限超過 |
| ERR-052 | 取得できるバージョン数を超えました。 | >10件保存 |

---

## 3. 処理仕様

### 3.1 処理概要

1. 最新 `ai_response` を取得し画面へ表示
2. 編集内容をローカルにドラフト保存
3. 保存時に差分生成 → 新バージョン付与
4. 追質問送信時は F-005 に context を添えて再実行依頼
5. 判定結果を F-007 へ送信

### 3.2 処理詳細

| 手順 | 処理内容 | 入力 | 出力 |
| ---- | -------- | ---- | ---- |
| 1 | データ取得 | inquiry_id | 回答セット |
| 2 | 編集 | オペ入力 | draft |
| 3 | 差分生成 | draft + base | diff JSON |
| 4 | 保存 | diff JSON | 新 version_no |
| 5 | 通知 | version info | Webhook → F-007 |

### 3.3 業務ルール

* 編集は敬体＋社内規定テンプレを維持
* 根拠の削除は理由記載必須
* コメントは内部メモで顧客に送付されない

### 3.4 例外処理

* 保存失敗時はブラウザ IndexedDB に退避
* 根拠ビューア取得失敗時は再取得ボタン表示
* 追質問 API 失敗時はリトライキューへ登録

---

## 4. API / 外部システム連携

| API ID | 名称 | 種別 | 呼び出し方向 |
| ------ | ---- | ---- | ------------ |
| API-RVW-01 | 回答取得API | REST | 画面 → バックエンド |
| API-RVW-02 | バージョン保存API | REST | 画面 → バックエンド |
| API-RVW-03 | 追質問API | REST | 画面 → F-005 |

**保存API リクエスト例**

```json
{
  "inquiry_id": "UUID",
  "version_no": 4,
  "ai_answer_text": "...",
  "operator_edits": {"diff": "..."},
  "comment": "再確認済み"
}
```

---

## 5. データ仕様

* `ai_response`：version_no をインクリメント、`operator_edits` に diff JSON を保存
* `review_comment`（新規）：`comment_id`, `inquiry_id`, `version_no`, `comment_text`, `created_by`

---

## 6. シーケンス図

```
レビューUI →[GET latest response]→ バックエンド
レビューUI ←[回答セット]← バックエンド
レビューUI →[PUT save]→ バックエンド
バックエンド →[INSERT ai_response]→ DB
バックエンド →[通知]→ 判定サポート(F-007)
レビューUI →[POST follow-up]→ F-005
```

