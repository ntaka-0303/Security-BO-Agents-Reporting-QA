# F-003 AI入力フォーム 仕様書

## 1. 概要

* **ドキュメント名**：F-003 AI入力フォーム 仕様書
* **対象機能**：帳票プレビューと質問文を AI エージェントへ送信し、解析ジョブを起動するフロントエンド画面
* **対応する機能要件**：業務要件 P-003、機能要件 F-003
* **担当者**：Reporting QA フロントエンド＋AI連携チーム
* **前提条件**：
  - inquiry_id、帳票ファイル URI、質問本文が F-001/F-002 から連携済み
  - AI 基盤（S-003）への API アクセス権とマスキングルールが設定済み
  - オペレーターは必要ロールでログイン済み
* **制約条件**：
  - 1 リクエストに添付できる帳票は 3 件まで、合計 50MB まで
  - 帳票プレビューは PDF ビューアに限定（HTML は静的描画）
  - 個人情報のマスキング（口座番号下 4 桁表示など）をクライアント側で適用

---

## 2. 画面仕様（UI仕様）

### 2.1 画面概要

* **画面ID**：AIN-001
* **画面名称**：AI入力フォーム
* **利用者ロール**：AI利用オペレーター（コンタクトセンター／営業店）

### 2.2 画面レイアウト

```
┌──────────────────────────────┐
│ 左：帳票プレビュー（タブ切替/最大3）                     │
│ 右上：質問本文エリア                                      │
│ 右中：追加メモ／タグ入力                                  │
│ 右下：送信ボタン／キャンセル／ステータス表示             │
└──────────────────────────────┘
```

### 2.3 画面項目一覧

| 項目ID | 項目名 | 型 | 必須 | 初期値 | 入力制御 | 備考 |
| ------ | ------ | -- | ---- | ------ | -------- | ---- |
| ITM-101 | 帳票プレビュー | viewer | ○ | F-002のURL | PDF/HTML | 3件までタブ表示 |
| ITM-102 | 問い合わせ本文 | textarea | ○ | F-001値 | 4000文字以内 | 編集可 |
| ITM-103 | 追加メモ | textarea | △ | 空 | 1000文字 | 任意 |
| ITM-104 | 補足タグ | multiselect | △ | 空 | 10件 | 例：再発、重要 |
| ITM-105 | マスキング結果 | text | ○ | 自動表示 | 参照のみ | 口座番号など |
| ITM-106 | 送信先モデル | select | ○ | `standard_rag` | プリセット3種 | 選択でプロンプト切替 |
| ITM-107 | 同意チェック | checkbox | ○ | OFF | true/false | 権限確認 |

### 2.4 ボタン／アクション仕様

| アクションID | アクション名 | 処理概要 |
| ------------ | ------------ | -------- |
| ACT-101 | AI解析依頼送信 | 入力値を整形し AI 基盤へ POST、job_id を受領 |
| ACT-102 | キャンセル | 画面を閉じ、未送信内容を破棄（保存オプションあり） |
| ACT-103 | 下書き保存 | 入力内容を `ai_request_draft` テーブルへ保存 |
| ACT-104 | ファイル追加 | 追加帳票を選択し、制限内ならプレビューへ反映 |

### 2.5 エラーメッセージ

| No | メッセージ | 表示条件 |
| -- | ---------- | -------- |
| ERR-030 | 帳票ファイルが未添付です。 | 帳票リストが空 |
| ERR-031 | ファイル数が上限（3件）を超えています。 | 4件目追加 |
| ERR-032 | マスキング処理に失敗しました。 | 前処理エラー |
| ERR-033 | AI基盤への送信に失敗しました。 | API失敗 |

---

## 3. 処理仕様

### 3.1 処理概要フロー

1. F-002 から取得した帳票をプレビューへ読み込み
2. フォーム入力＋マスキング確認
3. 入力チェック
4. AI 基盤（S-003）へ解析ジョブ投入
5. job_id と ai_request_id を記録し、ステータス表示

### 3.2 処理詳細

| 手順 | 処理内容 | 入力 | 出力 | 備考 |
| ---- | -------- | ---- | ---- | ---- |
| 1 | 帳票読込 | report_file_uri | viewer data | 変換キャッシュ |
| 2 | マスキング | 生テキスト | マスク済みテキスト | ルールベース |
| 3 | バリデーション | 入力値 | OK/NG | 文字数、タグ数 |
| 4 | AIジョブ生成 | inquiry_id 等 | job_id | API `POST /jobs` |
| 5 | DB保存 | job_id 等 | ai_request レコード | ai_request_id付与 |
| 6 | ステータス更新 | job_id | pending/failed | リアルタイム表示 |

### 3.3 業務ルール

* 送信先モデルに応じてプロンプトテンプレートを切替（税務/残高など）
* 入力内容は最後の送信から 30 分間のみ復元可能
* マスキング済テキストのみが AI へ送信される

### 3.4 例外処理

* AI基盤タイムアウト（>45秒）は `pending` のままリトライボタン表示
* 添付変換失敗は該当ファイルのみ無効にし、他ファイル送信可
* job_id 未取得時は DB ロールバックし ERR-033 を表示

---

## 4. API / 外部システム連携仕様

### 4.1 API一覧

| API ID | API名称 | IF種別 | 呼び出し方向 |
| ------ | ------- | ------ | ------------ |
| API-AI-01 | AI解析ジョブ投入API | REST/JSON | 本画面 → S-003 |
| API-AI-02 | AIジョブステータスAPI | REST/JSON | 本画面 → S-003 |

### 4.2 APIリクエスト仕様（解析ジョブ）

```
POST /ai/v1/jobs
Content-Type: application/json
```

```json
{
  "inquiry_id": "UUID",
  "report_uris": ["https://signed/.../r1.pdf"],
  "question_text": "...",
  "notes": "...",
  "customer_attributes": {...},
  "model_profile": "standard_rag"
}
```

### 4.3 APIレスポンス仕様

```json
{
  "job_id": "JOB-20251120-001",
  "status": "queued",
  "expires_at": "2025-11-20T09:15:00Z"
}
```

### 4.4 エラー仕様

| コード | 内容 | 対処 |
| ------ | ---- | ---- |
| 413 | Payload Too Large | ファイル数/サイズを案内 |
| 422 | Validation Error | 入力値を再編集 |
| 500 | AI基盤障害 | 再送ボタン＋監視通知 |

---

## 5. データ仕様

### 5.1 データ項目

| No | 論理名 | 物理名 | 型 | NULL | 説明 |
| -- | ------ | ------ | -- | ---- | ---- |
| ai_request_id | AI依頼ID | ai_request_id | char(36) | NOT NULL | 内部採番 |
| D-001 | 問い合わせID | inquiry_id | char(36) | NOT NULL | |
| report_uris | 帳票URI配列 | report_uris | jsonb | NOT NULL | 最大3件 |
| D-005 | 問い合わせ本文 | question_text | text | NOT NULL | |
| notes | 追加メモ | notes | text | NULL | |
| tags | 補足タグ | tags | jsonb | NULL | |
| model_profile | モデル種別 | model_profile | varchar(50) | NOT NULL | |
| job_id | AIジョブID | job_id | varchar(64) | NOT NULL | |
| status | 送信状態 | status | varchar(20) | NOT NULL | queued/pending |

### 5.2 テーブル定義

* **テーブル**：ai_request（新規）
* **主キー**：ai_request_id
* **FK**：inquiry_id → inquiry
* **備考**：job_id + inquiry_id のユニーク制約

---

## 6. シーケンス図

```
オペレーター →[入力確定]→ AI入力フォーム
AI入力フォーム →[帳票取得リクエスト]→ ストレージ
ストレージ →[署名付URL]→ AI入力フォーム
AI入力フォーム →[POST job]→ AI基盤
AI基盤 →[job_id]→ AI入力フォーム
AI入力フォーム →[保存]→ DB(ai_request)
AI入力フォーム →[完了通知]→ オペレーター
```

