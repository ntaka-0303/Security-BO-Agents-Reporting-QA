# F-004 帳票解析サービス 仕様書

## 1. 概要

* **ドキュメント名**：F-004 帳票解析サービス 仕様書
* **対象機能**：AI入力フォームから投入された帳票ファイルを解析し、RAG 向けのテキストチャンクとセクションインデックスを生成する内部サービス
* **対応する機能要件**：業務要件 P-004、機能要件 F-004
* **担当者**：Reporting QA AI基盤チーム
* **前提条件**：
  - F-002 で帳票ファイル URI と report_meta が生成済み
  - 帳票は PDF/HTML で OCR 不要、フォント情報取得可能
  - 解析ジョブはメッセージキュー経由でトリガーされる
* **制約条件**：
  - 1帳票あたり解析時間 60 秒以内
  - セクションIDは `reportType-page-section` 形式で一意
  - 個人情報は解析中もマスキングルール適用

---

## 2. 画面仕様

*内部バッチ処理のため UI なし。監視ダッシュボードのみ別途。*

---

## 3. 処理仕様

### 3.1 処理概要フロー

1. ジョブキューから帳票解析リクエストを受領
2. PDF/HTML を読み込み、構造化抽出（テキスト・テーブル・見出し）
3. セクションインデックスを生成し `report_meta` を更新
4. テキストチャンクを生成してベクトルストアへ登録
5. 結果を F-005 へ通知、ステータス更新

### 3.2 処理詳細

| 手順 | 処理内容 | 入力 | 出力 | 備考 |
| ---- | -------- | ---- | ---- | ---- |
| 1 | ジョブ受信 | job_id, report_meta_id | - | MQ から pull |
| 2 | ファイル取得 | report_file_uri | binary | 署名付きURL |
| 3 | 構造化解析 | binary | section list | PDF: text layer、HTML: DOM |
| 4 | チャンク生成 | section list | chunks | 400文字目安、重複許容 |
| 5 | ベクトル登録 | chunks | vector_ids | Embedding API 呼出 |
| 6 | DB更新 | section list | report_meta 更新 | structured_json/upd_ts |
| 7 | ステータス通知 | job_id | success/failure | F-003/F-005 に通知 |

### 3.3 業務ルール

* 表形式はセルを維持したまま JSON に格納
* 重要セクション（残高・取引概要）はタグ `priority:true` を付与
* チャンクにはページ番号と座標を必須で付与（根拠表示用）

### 3.4 例外処理

* 解析失敗時は `ERR-040` を F-003 へ返却し、ジョブは最大 2 回リトライ
* ファイル取得失敗は署名付き URL の再発行を試し、失敗時は中断
* Embedding API 障害時はバックオフ付きリトライ

---

## 4. API / 外部システム連携

### 4.1 API一覧

| API ID | API名称 | IF種別 | 呼び出し方向 |
| ------ | ------- | ------ | ------------ |
| API-EMB-01 | Embedding生成API | REST | 本サービス → AI基盤 |
| API-VEC-01 | ベクトルストア登録API | REST | 本サービス → Vector DB |

### 4.2 APIリクエスト仕様（Embedding）

```json
{
  "input_text": "2024年○○証券...",
  "model": "embedding-secure-v1"
}
```

### 4.3 APIレスポンス仕様

```json
{
  "embedding": [0.01, -0.03, ...],
  "vector_id": "vec_123"
}
```

### 4.4 エラー仕様

| コード | 内容 | 対処 |
| ------ | ---- | ---- |
| 408 | Timeout | 再試行（最大3回） |
| 500 | Service Error | フォールバックモデルへ切替 |

---

## 5. データ仕様

### 5.1 データ項目

| 名称 | 説明 |
| ---- | ---- |
| report_meta_id | 解析対象帳票メタ ID |
| section_id | `reportType-page-section` 形式 |
| section_title | 見出し名 |
| section_text | 生テキスト |
| coordinates | ページ内座標 (x1,y1,x2,y2) |
| chunk_id | ベクトル登録ID |
| vector_ref | ベクトルストアキー |

### 5.2 テーブル/ストレージ

* `report_meta.report_structured_json` に section 情報を格納
* `ai_response_sources`（新設）で chunk_id と vector_ref を管理

---

## 6. シーケンス図

```
AI入力フォーム/F-003 →[ジョブ投入]→ 解析ジョブキュー
解析サービス(F-004) →[ジョブ取得]→ MQ
解析サービス →[帳票ダウンロード]→ ストレージ
解析サービス →[Embedding]→ AI基盤
解析サービス →[ベクトル登録]→ Vector DB
解析サービス →[構造化情報更新]→ DB(report_meta)
解析サービス →[完了通知]→ F-005
```

