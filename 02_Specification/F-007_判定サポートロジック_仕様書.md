# F-007 判定サポートロジック 仕様書

## 1. 概要

* **ドキュメント名**：F-007 判定サポートロジック 仕様書
* **対象機能**：AI回答案の自信度や編集量を基に顧客へ即回答できるか/バックオフィスへエスカレーションすべきかを自動判定してオペレーターへ提示する内部ロジック
* **対応する機能要件**：業務要件 P-007、機能要件 F-007
* **担当者**：Reporting QA ビジネスロジックチーム
* **前提条件**：
  - F-005 から自信度(confidence_score)と根拠件数が提供される
  - F-006 からオペレーター編集量（差分率）が計算可能
  - 判定結果を保存するテーブル/ログが存在
* **制約条件**：
  - 判定は推奨に留まり最終決定は人が行う
  - 業務ルール変更時はルールセットのバージョン管理が必要
  - AI判断のみで顧客へ送信することは禁止（常にオペレーター確認あり）

---

## 2. 画面仕様

*UI なし。F-006 画面上にバッジとして表示される。*

---

## 3. 処理仕様

### 3.1 処理概要フロー

1. F-006 保存イベントをトリガーに入力指標を取得
2. ルールエンジンでスコアリング（自信度、編集量、根拠欠落など）
3. 判定（Yes/No/Review）と理由、推奨アクションを生成
4. 判定結果を DB に保存し、F-006/F-008/F-009 へ通知

### 3.2 処理詳細

| 手順 | 処理内容 | 入力 | 出力 | 備考 |
| ---- | -------- | ---- | ---- | ---- |
| 1 | 指標収集 | confidence_score, evidence_count, diff_ratio | feature set | diff_ratio=編集文字数/原文 |
| 2 | ルール評価 | feature set | interim results | ルールバージョン付与 |
| 3 | 判定決定 | interim results | decision {yes/no/review} | 表1参照 |
| 4 | 推奨生成 | decision | message | 例：「AIのみで回答可能」 |
| 5 | 永続化 | decision +理由 | escalation_suggestion | DB insert |
| 6 | 通知 | decision payload | Webhook | F-006/008/009 |

### 3.3 業務ルール（抜粋）

| 条件 | 提案 |
| ---- | ---- |
| confidence ≥ 0.7 かつ diff_ratio < 0.2 かつ evidence_count ≥ 2 | Yes（AIのみで回答可） |
| evidence_count < 2 または 自信度 < 0.6 | No（エスカレーション推奨） |
| 0.6 ≤ confidence < 0.7 または diff_ratio ≥ 0.2 | Review（要追加確認） |

* No 判定時は escalation_reason テンプレ候補を自動生成
* Review 以上では必ず F-006 にコメント入力を促す

### 3.4 例外処理

* 指標取得に失敗した場合は `decision=unknown` を返し F-006 にアラート表示
* ルール評価エンジン障害時はフェイルオープン（判定提示なし）
* 保存失敗時は再試行し、それでも失敗なら監査ログへアラート

---

## 4. API / 外部システム連携

| API ID | 名称 | 種別 | 説明 |
| ------ | ---- | ---- | ---- |
| API-JDG-01 | 判定リクエストAPI | REST | F-006→本ロジック |
| API-JDG-02 | 判定通知Webhook | REST | 本ロジック→F-006/F-008/F-009 |

**判定リクエスト例**

```json
{
  "inquiry_id": "UUID",
  "version_no": 4,
  "confidence_score": 0.75,
  "evidence_count": 3,
  "diff_ratio": 0.12
}
```

**レスポンス例**

```json
{
  "decision": "yes",
  "reason": "高自信度かつ編集軽微",
  "suggested_next_action": "顧客回答送信手続きへ進んでください"
}
```

---

## 5. データ仕様

* `escalation_suggestion` テーブル
  - `suggestion_id` (PK), `inquiry_id`, `version_no`, `decision`, `reason_code`, `diff_ratio`, `confidence_score`, `created_at`
* `decision_audit_log` でルールバージョン・入力指標を履歴化

---

## 6. シーケンス図

```
F-006 レビューUI →[判定リクエスト]→ 判定ロジック(F-007)
判定ロジック →[ルール評価]→ ルールセット
判定ロジック →[保存]→ DB(escalation_suggestion)
判定ロジック →[通知]→ F-006/F-008/F-009
F-006/F-008 →[結果表示]→ オペレーター
```

