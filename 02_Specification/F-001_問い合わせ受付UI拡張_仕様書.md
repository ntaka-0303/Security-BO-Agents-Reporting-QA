# F-001 問い合わせ受付UI拡張 仕様書

## 1. 概要

* **ドキュメント名**：F-001 問い合わせ受付UI拡張 仕様書
* **対象機能**：一次受付オペレーターが帳票問い合わせを起票し、AI連携フラグや帳票種別を登録する UI
* **対応する機能要件**：業務要件 P-001、機能要件 F-001（`03_機能要件定義書_reporting_QA_agent.md`）
* **担当者**：Reporting QA フロントエンド開発チーム
* **前提条件**：
  - CRM（S-001）とシングルサインオン済みで、問い合わせチケット API が利用可能であること
  - 帳票種別マスタ、顧客マスタが同期済みで最新状態であること
  - PoC 対象帳票に限定した問い合わせであること
* **制約条件**：
  - 顧客回答前に必ずオペレーター／バックオフィス確認を経るため、AI 連携は補助扱い
  - 添付ファイルは PDF のみ・最大 25MB、AI 連携 ON の場合は帳票添付または帳票ID必須
  - 監査要件のため全入力値・AI 連携設定を監査ログに残す

---

## 2. 画面仕様（UI仕様）

### 2.1 画面概要

* **画面ID**：INQ-001
* **画面名称**：問い合わせ受付＋AI連携設定画面
* **利用者ロール**：一次受付オペレーター（コンタクトセンター／営業店）

### 2.2 画面レイアウト（ワイヤーフレーム）

```
┌──────────────────────────────┐
│ 顧客検索（顧客ID/顧客名） [検索]                          │
├──────────────────────────────┤
│ 問い合わせ基本情報                                          │
│  ├ 問い合わせ種別 [select]                                 │
│  ├ 問い合わせ内容 [textarea]                               │
│  └ 顧客属性タグ（複数選択）                                │
├──────────────────────────────┤
│ AI連携設定                                                  │
│  ├ [ ] AI連携を利用する                                    │
│  ├ 帳票添付 [PDF upload] / 帳票ID入力                      │
│  └ 送信予約ボタン                                           │
└──────────────────────────────┘
```

### 2.3 画面項目一覧

| 項目ID | 項目名 | 型 | 必須 | 初期値 | 入力制御 | 備考 |
| ------ | ------ | -- | ---- | ------ | -------- | ---- |
| ITM-001 | 顧客ID | text | ○ | なし | 半角英数20桁上限 | CRM検索で補完 |
| ITM-002 | 顧客名 | text | ○ | なし | 全角50文字 | CRMレスポンス読み取り |
| ITM-003 | 問い合わせ種別 | select | ○ | なし | プルダウン（帳票種別） | 未選択時は保存不可 |
| ITM-004 | 問い合わせ内容 | textarea | ○ | 既存テンプレ | 2000文字以内 | 改行可 |
| ITM-005 | 顧客属性タグ | multiselect | △ | 前回値 | 最大5件 | CRMマスタ連携 |
| ITM-006 | AI連携利用 | checkbox | ○ | ON | true/false | OFF時は帳票添付不要 |
| ITM-007 | 帳票添付 | file | △ | なし | PDF/25MB以下 | AI連携ON時は必須（帳票IDといずれか必須） |
| ITM-008 | 帳票ID | text | △ | なし | 半角英数 | 添付代替 |
| ITM-009 | 送信予約時刻 | datetime | △ | 現在時刻+5分 | 最短+5分、24h以内 | 任意で AI 連携依頼を後ろ倒し |

### 2.4 ボタン／アクション仕様

| アクションID | アクション名 | 処理概要 |
| ------------ | ------------ | -------- |
| ACT-001 | 顧客検索 | 顧客ID/顧客名を CRM へ送信し、顧客情報・属性を取得してフォームへ反映 |
| ACT-002 | チケット登録 | 入力値をバリデーション後、CRM へ問い合わせチケットを起票し、inquiry テーブルへ保存 |
| ACT-003 | AI連携送信予約 | チケット登録済みデータをキューへ投入し、AI 入力フォーム（F-003）へ連携フラグを渡す |
| ACT-004 | 添付ファイル検証 | アップロード直後にファイル形式／容量を検証し、ストレージ一時領域へ格納 |

### 2.5 エラーメッセージ

| No | メッセージ | 表示条件 |
| -- | ---------- | -------- |
| ERR-001 | 必須項目が未入力です。 | 顧客ID/種別/内容が欠落 |
| ERR-002 | 添付ファイル形式が不正です（PDFのみ）。 | 非PDFアップロード |
| ERR-003 | 帳票添付または帳票IDを指定してください。 | AI連携ONかつ両方未入力 |
| ERR-010 | CRM連携に失敗しました。再度お試しください。 | CRM API エラー |

---

## 3. 処理仕様（ロジック仕様）

### 3.1 処理概要フロー

1. オペレーターが顧客情報を検索し、問合せ内容を入力
2. フォームバリデーション
3. CRM チケット起票 API 呼び出し
4. AI 連携キュー登録（AI 利用時）
5. 結果を画面へ通知し、inquiry/CRM に記録

### 3.2 処理詳細

| 手順 | 処理内容 | 入力 | 出力 | 備考 |
| ---- | -------- | ---- | ---- | ---- |
| 1 | 顧客検索 | 顧客ID/顧客名 | 顧客属性JSON | OAuth トークン付与 |
| 2 | 入力チェック | 画面入力値 | チェック結果 | 必須・文字種・サイズを検証 |
| 3 | チケット起票 | 正常な入力値 | inquiry_id | CRM API `POST /tickets` |
| 4 | ローカル保存 | 入力＋inquiry_id | inquiry レコード | DBトランザクション |
| 5 | AI連携キュー投入 | inquiry_id + 添付情報 | ai_request_id | F-003 で参照するジョブ |
| 6 | レスポンス返却 | 成功/失敗ステータス | 画面通知 | 失敗時はロールバック |

### 3.3 業務ルール

* AI連携利用が OFF の場合でもチケット起票は必須
* 添付ファイルは自動でマルウェアスキャンに送付（結果が NG なら ERR-011 で拒否）
* 問い合わせ種別に応じて CRM 側テンプレート ID を切り替える

### 3.4 例外処理

* CRM エラー（5xx）時は 3 回までリトライ、その後 ERR-010 を表示
* 添付アップロード失敗時はキャッシュをクリアし再アップロードを促す
* AI連携キュー登録失敗時はチケット登録は維持し、別タスクへ再送指示（ERR-012）

---

## 4. API / 外部システム連携仕様

### 4.1 API一覧

| API ID | API名称 | IF種別 | 呼び出し方向 |
| ------ | ------- | ------ | ------------ |
| API-CRM-01 | 顧客検索API | REST/JSON | 本画面 → CRM (S-001) |
| API-CRM-02 | チケット起票API | REST/JSON | 本画面 → CRM (S-001) |
| API-AI-01 | AI連携キュー登録API | REST/JSON | 本画面 → AI入力サービス(F-003) |

### 4.2 APIリクエスト仕様（例：チケット起票）

```
POST /crm/v1/tickets
Authorization: Bearer <token>
Content-Type: application/json
```

```json
{
  "inquiry_id": "UUID",
  "customer_id": "C123456789",
  "category": "annual_report",
  "question_text": "...",
  "ai_enabled": true,
  "attachments": [
    {"file_name": "report.pdf", "uri": "s3://tmp/..."}
  ]
}
```

### 4.3 APIレスポンス仕様

```json
{
  "ticket_id": "UUID",
  "status": "created",
  "created_at": "2025-11-20T09:00:00Z"
}
```

### 4.4 エラー仕様

| エラーコード | 内容 | 対処 |
| ------------ | ---- | ---- |
| 401 | 認証エラー | トークンを更新し再試行 |
| 409 | 重複チケット | 既存チケット情報を画面表示 |
| 500 | CRM障害 | リトライ後に保守窓口へ通知 |

---

## 5. データ仕様（データ定義）

### 5.1 データ項目一覧

| No | 論理名 | 物理名 | 型 | 桁数 | NULL | 説明 |
| -- | ------ | ------ | -- | ---- | ---- | ---- |
| D-001 | 問い合わせID | inquiry_id | char | 36 | NOT NULL | CRMチケットID |
| D-002 | 顧客識別子 | customer_id | varchar | 20 | NOT NULL | 顧客番号 |
| D-003 | 問い合わせ種別 | inquiry_category | varchar | 50 | NOT NULL | 帳票種別 |
| D-005 | 問い合わせ本文 | question_text | text | - | NOT NULL | 顧客質問 |
| D-006 | 顧客属性 | customer_attributes | jsonb | - | NULL | CRM属性 |
| ai_enabled | AI利用フラグ | ai_enabled | boolean | 1 | NOT NULL | true/false |
| created_by | 起票者ID | created_by | varchar | 50 | NOT NULL | オペレーターID |

### 5.2 テーブル定義（inquiry）

* **テーブル名**：inquiry
* **主キー**：inquiry_id
* **カラム定義**：`05_テーブル定義_reporting_QA_agent.md` に準拠し、上記項目に加えて `created_at`、`updated_at` を保持

---

## 6. シーケンス図（概要）

```
オペレーター →[入力送信]→ 問い合わせUI(INQ-001)
問い合わせUI →[顧客検索]→ CRM
CRM →[顧客情報]→ 問い合わせUI
オペレーター →[チケット登録]→ 問い合わせUI
問い合わせUI →[POST ticket]→ CRM
CRM →[ticket_id]→ 問い合わせUI
問い合わせUI →[キュー登録]→ AI入力サービス(F-003)
AI入力サービス →[job_id]→ 問い合わせUI
問い合わせUI →[完了通知]→ オペレーター
```

