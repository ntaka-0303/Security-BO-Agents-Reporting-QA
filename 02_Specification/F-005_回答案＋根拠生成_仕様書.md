# F-005 回答案＋根拠生成 仕様書

## 1. 概要

* **ドキュメント名**：F-005 回答案＋根拠生成 仕様書
* **対象機能**：帳票解析済みデータと質問をもとに LLM＋RAG で回答案・根拠・オペメモを生成するバックエンドサービス
* **対応する機能要件**：業務要件 P-005、機能要件 F-005
* **担当者**：Reporting QA AI推論チーム
* **前提条件**：
  - F-003 で AI リクエストが作成され job_id が発行済み
  - F-004 でチャンクがベクトルストアへ登録済み
  - プロンプトテンプレート／ガードレールが最新
* **制約条件**：
  - 回答案は敬体で 400 字以内、禁止語リストを適用
  - 根拠は最低 2 箇所、ページ番号必須
  - 自信度 0.6 未満は自動でエスカレーション推奨

---

## 2. 画面仕様

*システム処理のため UI なし。F-006 に結果を表示。*

---

## 3. 処理仕様

### 3.1 処理概要フロー

1. job_id をキーに F-003 から質問情報を取得
2. ベクトル検索で関連チャンクを 8 件取得
3. プロンプトテンプレートを生成し LLM へ投げる
4. 回答案・根拠リスト・オペメモを生成
5. コンポーネント検証（字数、NGワード、自信度計算）
6. `ai_response` テーブルへ保存し F-006 へ通知

### 3.2 処理詳細

| 手順 | 処理内容 | 入力 | 出力 | 備考 |
| ---- | -------- | ---- | ---- | ---- |
| 1 | コンテキスト取得 | inquiry_id, job_id | question bundle | |
| 2 | ベクトル検索 | question_text | topK chunks | cosine 類似度 |
| 3 | プロンプト構築 | chunks + メタ | prompt text | ルール埋込 |
| 4 | LLM推論 | prompt | draft answer | モデル: `secure-rag-gpt` |
| 5 | 根拠整形 | chunks | evidence list | page, section, quote |
| 6 | 自信度算出 | LLM score + chunk coverage | confidence_score | 0-1 |
| 7 | 保存 | 各結果 | ai_response レコード | version 管理 |
| 8 | 通知 | ai_response_id | event | Webhook/F-006 |

### 3.3 業務ルール

* 句読点・敬称を金融向けテンプレに統一
* 根拠には「ページ X / セクション名」を必ず含む
* オペメモには次の行動や注意事項を記載（例：残高確認要）

### 3.4 例外処理

* LLM タイムアウト時は別リージョンのバックアップモデルへ切替
* 取得チャンクが 2 件未満なら `confidence_score` を 0.4 以下に強制
* 推論エラー時は `ai_response` に失敗記録を残し、F-006 に再送ボタン表示

---

## 4. API / 外部システム連携

### 4.1 API一覧

| API ID | API名称 | IF種別 | 呼び出し方向 |
| ------ | ------- | ------ | ------------ |
| API-LLM-01 | 回答案生成API | REST | 本サービス → LLM推論基盤 |
| API-VEC-02 | ベクトル検索API | REST | 本サービス → Vector DB |

### 4.2 APIリクエスト仕様（LLM）

```json
{
  "model": "secure-rag-gpt",
  "prompt": "あなたは証券会社のカスタマーサポート担当です...",
  "max_tokens": 600,
  "temperature": 0.2
}
```

### 4.3 APIレスポンス仕様

```json
{
  "answer": "お問い合わせありがとうございます。...",
  "citations": [
    {"section_id": "annual-3-2", "quote": "..." }
  ],
  "confidence": 0.72
}
```

### 4.4 エラー仕様

| コード | 内容 | 対処 |
| ------ | ---- | ---- |
| 429 | Rate Limit | キューへ戻し遅延再実行 |
| 500 | モデル障害 | バックアップモデルへ切替 |

---

## 5. データ仕様

### 5.1 データ項目

| No | 論理名 | 物理名 | 型 | NULL | 説明 |
| -- | ------ | ------ | -- | ---- | ---- |
| ai_response_id | AI出力ID | ai_response_id | char(36) | NOT NULL | 主キー |
| D-001 | 問い合わせID | inquiry_id | char(36) | NOT NULL | FK |
| D-007 | AI回答案 | ai_answer_draft | text | NOT NULL | |
| D-008 | 根拠参照情報 | evidence_refs | jsonb | NOT NULL | section/quote |
| operator_edits | オペ修正 | operator_edits | jsonb | NULL | 初期 null |
| confidence_score | 自信度 | numeric(3,2) | NOT NULL | 0-1 |
| version_no | バージョン番号 | integer | NOT NULL | 1..n |
| created_at | 生成日時 | timestamp | NOT NULL | |

### 5.2 テーブル定義

* `ai_response`：`05_テーブル定義` に準拠、version ユニーク (inquiry_id, version_no)

---

## 6. シーケンス図

```
AI入力フォーム(F-003) →[job_id通知]→ 回答案生成(F-005)
回答案生成 →[ベクトル検索]→ Vector DB
回答案生成 →[LLM呼出]→ LLM基盤
LLM基盤 →[回答,根拠,自信度]→ 回答案生成
回答案生成 →[保存]→ DB(ai_response)
回答案生成 →[通知]→ 回答案レビューUI(F-006)
```

