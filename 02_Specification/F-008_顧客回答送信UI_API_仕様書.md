# F-008 顧客回答送信UI/API 仕様書

## 1. 概要

* **ドキュメント名**：F-008 顧客回答送信UI/API 仕様書
* **対象機能**：承認済み回答文を選択したチャネル（メール/チャット/電話）で顧客へ送信し、送信ログを CRM と監査テーブルへ登録する UI＋API
* **対応する機能要件**：業務要件 P-008、機能要件 F-008
* **担当者**：Reporting QA フロントエンド＆連携チーム
* **前提条件**：
  - F-006/F-010 で承認済み回答が確定し、判定結果が Yes または BO 完了
  - 顧客連絡先（メール・チャットID・電話番号）が CRM で有効
  - コンプライアンスチェックリストが最新
* **制約条件**：
  - 送信前にチェックボックスで遵守事項確認必須
  - 添付ファイルはバックオフィス承認済みのみ選択可
  - 全送信ログは `final_response_log` に同期、編集不可

---

## 2. 画面仕様

### 2.1 画面概要

* **画面ID**：OUT-001
* **画面名称**：顧客回答送信
* **利用者ロール**：最終回答オペレーター

### 2.2 レイアウト

```
上：顧客情報/チャネル選択
中：最終回答プレビュー（編集不可）
下：添付選択、チェックリスト、送信/下書きボタン
右：送信結果タイムライン
```

### 2.3 項目一覧

| 項目ID | 項目名 | 型 | 必須 | 備考 |
| ------ | ------ | -- | ---- | ---- |
| ITM-301 | 顧客氏名/ID | label | ○ | 参照のみ |
| ITM-302 | チャネル選択 | select | ○ | email/chat/phone |
| ITM-303 | 送信先アドレス/ID | text | ○ | チャネルに応じバリデーション |
| ITM-304 | 最終回答文 | viewer | ○ | 編集不可 |
| ITM-305 | 添付選択 | multiselect | △ | 承認済みのみ |
| ITM-306 | コンプライアンス確認 | checkbox | ○ | チェック必須 |
| ITM-307 | 備考メモ | textarea | △ | 内部ログ用 |

### 2.4 アクション

| アクションID | 名称 | 処理 |
| ------------ | ---- | ---- |
| ACT-301 | 送信 | チャネル毎の API を呼出し、成功時に final_response_log 更新 |
| ACT-302 | 下書き保存 | 入力内容をドラフトテーブルへ保存 |
| ACT-303 | プレビュー送信 | 自身へコピー送信し内容確認（メールのみ） |

### 2.5 エラーメッセージ

| No | メッセージ | 条件 |
| -- | ---------- | ---- |
| ERR-060 | 送信先アドレスが未設定です。 | email/chat で空 |
| ERR-061 | コンプライアンス確認が未完了です。 | チェック未実施 |
| ERR-062 | 送信に失敗しました。再送待ちに設定しました。 | 外部API失敗 |

---

## 3. 処理仕様

### 3.1 フロー

1. inquiry_id をキーに承認済み回答と判定結果を取得
2. 送信チャネル／先を選択しバリデーション
3. コンプライアンスチェックを確認
4. チャネル別ゲートウェイ API を呼び出し送信
5. `final_response_log` に結果保存、CRM へも記録
6. 失敗時はステータス `retry_pending` としてキュー登録

### 3.2 詳細

| 手順 | 入力 | 出力 | 備考 |
| ---- | ---- | ---- | ---- |
| 1 | inquiry_id | final_response_text | DB 取得 |
| 2 | 送信先情報 | バリデ結果 | 形式検証 |
| 3 | 送信 | payload | API-OUT-01/02 |
| 4 | レスポンス | sent_status | 成功/失敗 |
| 5 | 保存 | sent_status | final_response_log 更新 |
| 6 | 通知 | sent_status | CRM /監査DWH |

### 3.3 業務ルール

* 電話チャネルは通話ログのみ登録、実際の通話は外部 PBX
* メール送信時は自動で BCC に監査アドレス追加
* チャット送信では Markdown → プレーンテキストのサニタイズ実施

### 3.4 例外処理

* 外部ゲートウェイ 4xx はオペレーターに修正依頼、5xx は自動リトライ
* 添付ファイルが期限切れの場合は再取得を促す
* CRM 連携失敗時は送信成功でもアラート表示（後続で手動連携）

---

## 4. API / 外部システム連携

| API ID | 名称 | 説明 |
| ------ | ---- | ---- |
| API-OUT-01 | メールゲートウェイ送信API | REST、本システム→メールGW |
| API-OUT-02 | チャットゲートウェイ送信API | REST、本システム→チャットGW |
| API-CRM-03 | CRM回答履歴登録API | REST、本システム→CRM |

**メール送信リクエスト例**

```json
{
  "message_id": "MSG-001",
  "to": ["customer@example.com"],
  "bcc": ["audit@example.com"],
  "subject": "お問い合わせの件",
  "body": "・・・",
  "attachments": [{"uri": "s3://..."}]
}
```

---

## 5. データ仕様

* `final_response_log`：`audit_log_id`, `inquiry_id`, `final_response_text`, `channel`, `sent_at`, `sender_id`, `attachments`
* `send_job`（再送キュー）：`job_id`, `inquiry_id`, `channel`, `status`, `retry_count`

---

## 6. シーケンス図

```
オペレーター →[送信リクエスト]→ 顧客回答送信UI
顧客回答送信UI →[検証]→ バリデーションロジック
顧客回答送信UI →[送信API呼出]→ メール/チャットGW
ゲートウェイ →[結果]→ 顧客回答送信UI
顧客回答送信UI →[保存]→ final_response_log
顧客回答送信UI →[履歴登録]→ CRM
顧客回答送信UI →[完了通知]→ オペレーター
```

