# F-011 最終回答ログ／監査 仕様書

## 1. 概要

* **ドキュメント名**：F-011 最終回答ログ／監査 仕様書
* **対象機能**：顧客送信結果（チャネル・最終文面・根拠リンク等）を監査要件に沿って長期保管し、監査DWHへ連携する内部処理
* **対応する機能要件**：業務要件 P-011、機能要件 F-011
* **担当者**：Reporting QA ログ/監査チーム
* **前提条件**：
  - F-008 で送信結果が生成され、audit_log_id が採番済み
  - バックオフィス回答（F-010）が紐付く場合がある
  - 監査 DWH へのバッチ転送経路が用意されている
* **制約条件**：
  - ログ保管期間 7 年、WORM ストレージへ日次エクスポート
  - 個人情報含むためアクセスは監査ロールのみ
  - 送信内容は追記のみ可能（改ざん禁止）

---

## 2. 画面仕様

*監査員向けビューアは別システム。ここではロジックのみ。*

---

## 3. 処理仕様

### 3.1 フロー

1. F-008 送信成功イベントを受信
2. `final_response_log` に記録（送信チャネル、時刻、文面、添付）
3. バックオフィス回答（F-010）が存在すれば紐付け
4. 監査メタデータ（根拠リンク、モデルバージョン等）を付加
5. 日次で監査 DWH へバッチ転送、WORM ストレージへアーカイブ

### 3.2 詳細

| 手順 | 処理内容 | 入力 | 出力 |
| ---- | -------- | ---- | ---- |
| 1 | イベント受信 | send_result payload | queue message |
| 2 | DB登録 | payload | final_response_log レコード |
| 3 | 根拠紐付け | evidence_refs | audit bundle |
| 4 | 監査パッケージ生成 | audit bundle | export file (CSV/JSON) |
| 5 | 転送 | export file | DWH/S3 |

### 3.3 業務ルール

* final_response_text は正規化（余分な空白除去）後に保存
* 監査ログには送信経路、判定決定者、AIモデルバージョンをセット
* バックオフィス回答がある場合は `bo_response_text` を添付

### 3.4 例外処理

* DB 書込失敗：即時リトライ後、失敗ならアラート＋手動再登録
* DWH 転送失敗：再送ジョブを自動起動、3 回失敗で監査へ通知
* WORM 書き込み失敗：保留状態で監査ロールへアラート

---

## 4. API / 外部システム連携

| API ID | 名称 | 説明 |
| ------ | ---- | ---- |
| API-AUD-01 | 監査DWH転送API | Batch、本システム→監査DWH |
| API-STG-02 | WORMストレージ保存API | REST | 本システム→ストレージ |

**転送ファイル例（JSON）**

```json
{
  "audit_log_id": "AUD-001",
  "inquiry_id": "UUID",
  "final_response_text": "...",
  "channel": "email",
  "sent_at": "2025-11-20T09:30:00+09:00",
  "sender_id": "op01",
  "evidence_refs": [...],
  "decision": "yes",
  "model_version": "secure-rag-gpt-1.2"
}
```

---

## 5. データ仕様

* `final_response_log` テーブル：`audit_log_id` (PK), `inquiry_id`, `final_response_text`, `channel`, `sent_at`, `sender_id`, `bo_response_text`, `attachments`
* `audit_export_history`（新規）：`export_id`, `audit_log_id`, `batch_date`, `status`, `retry_count`

---

## 6. シーケンス図

```
顧客回答送信UI(F-008) →[送信成功イベント]→ 監査ロジック(F-011)
F-011 →[INSERT]→ DB(final_response_log)
F-011 →[紐付け]→ ai_response/evidence
F-011 →[日次バッチ]→ 監査DWH
F-011 →[保存]→ WORMストレージ
監査員 →[参照]→ 監査DWH
```

