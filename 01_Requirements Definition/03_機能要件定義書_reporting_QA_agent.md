# 帳票理解・QAエージェント（報告書問い合わせ対応）機能要件定義書

## 1. 前提・背景
* **対象業務**: 顧客・営業店・社内からの帳票に関する問い合わせ対応（PoC 対象：特定口座年間取引報告書／取引報告書／残高報告書）
* **関連する業務詳細書**: `02_業務要件定義書_reporting_QA_agent.md`（P-001〜P-011）
* **開発対象範囲（In Scope）**:
  - 問い合わせ管理システムとの連携と AI 入力 UI
  - 帳票データの取得・前処理・構造化
  - LLM＋RAG を用いた回答案・根拠生成
  - オペレーター向けレビュー／編集／判定 UI
  - バックオフィスへのエスカレーション管理と最終回答ログ
* **対象外（Out of Scope）**:
  - 顧客への完全自動応答（人手確認なし）
  - PoC 対象外帳票や紙帳票スキャン OCR の高度化
  - モデル学習データの生成プロセス・MLOps 全般
* **前提条件**:
  - 帳票仕様書・項目定義書および FAQ／標準回答例が整備されていること
  - PoC 環境で個人情報を扱う際のマスキング／権限管理ルールが適用されること
  - 問い合わせ管理システムから必要なメタデータ（顧客属性・履歴）を取得可能であること
* **制約条件**:
  - 顧客回答前に必ずオペレーターまたはバックオフィスが内容を確認する
  - 監査対応のため、帳票データ・AI 出力・編集履歴・送信ログを保存する
  - クラウド利用時は社内セキュリティ基準（通信暗号化・アクセスログ等）に準拠する

---

## 2. 機能一覧

| No.   | 対応プロセス（P-XXX） | 機能名称 | 種別（画面/UI・API・内部処理） | 概要 |
| ----- | -------------------- | -------- | ------------------------------ | ---- |
| F-001 | P-001 | 問い合わせ受付UI拡張 | UI | 顧客質問・属性の入力とチケット起票、AI連携フラグ設定 |
| F-002 | P-002 | 帳票取得連携API | API | 顧客ID等を基に帳票システムから対象帳票を検索・取得 |
| F-003 | P-003 | AI入力フォーム | UI | 帳票ファイルと質問文、任意メモをAIエージェントへ送信 |
| F-004 | P-004 | 帳票解析サービス | 内部処理 | PDF/HTMLを構造化し、セクション・項目単位でインデックス化 |
| F-005 | P-005 | 回答案＋根拠生成 | 内部処理 | LLM＋RAGで回答案、該当箇所抜粋、オペレーター向けメモを生成 |
| F-006 | P-006 | 回答案レビュー画面 | UI | AI出力の確認・編集・バージョン管理、追加質問送信 |
| F-007 | P-007 | 判定サポートロジック | 内部処理 | ルール/ヒントに基づき「AIのみで回答可否」を判定し提案 |
| F-008 | P-008 | 顧客回答送信UI/API | UI | 承認済み回答をメール/チャットへ送信し、CRMへ記録 |
| F-009 | P-009 | エスカレーション管理 | UI | エスカレーション理由・添付資料を整理しバックオフィスへ送付 |
| F-010 | P-010 | バックオフィス検証画面 | UI | AI出力と原本帳票を参照し、補足調査結果と回答案を編集 |
| F-011 | P-011 | 最終回答ログ／監査 | 内部処理 | 送信経路・最終文面・根拠リンクを一元保存し監査に提供 |

---

## 3. 機能詳細
各機能の詳細仕様は `Security BO Agents /Template/機能詳細_テンプレート.md` に準拠して別途作成する。優先度の高い F-003〜F-008 について先行して詳細化し、残機能は PoC 結果に応じて追加する。

---

## 4. データ項目定義（Data Dictionary）

| No.  | データ項目名 | 物理名 | 型 | 桁数 | Nullable | 説明 |
| ---- | ------------ | ------ | -- | ---- | -------- | ---- |
| D-001 | 問い合わせID | inquiry_id | string | 36 | NOT NULL | 問い合わせ管理システムのチケットID（UUID） |
| D-002 | 顧客識別子 | customer_id | string | 20 | NOT NULL | 顧客番号または匿名化ID |
| D-003 | 問い合わせ種別 | inquiry_category | string | 50 | NOT NULL | 帳票種別や質問カテゴリ |
| D-004 | 帳票ファイルパス | report_file_uri | string | 255 | NOT NULL | 取得した帳票ファイルのストレージURI |
| D-005 | 問い合わせ本文 | question_text | text | - | NOT NULL | 顧客からの自然文質問 |
| D-006 | 顧客属性 | customer_attributes | json | - | NULLABLE | 経験年数・法人/個人等のメタ情報 |
| D-007 | AI回答案 | ai_answer_draft | text | - | NOT NULL | LLMが生成した対顧客向け文案 |
| D-008 | 根拠参照情報 | evidence_refs | json | - | NOT NULL | ページ番号・項目名・抜粋テキスト等 |
| D-009 | オペレーター編集履歴 | operator_edits | json | - | NULLABLE | 編集前後差分・コメント |
| D-010 | エスカレーション判定 | escalation_flag | boolean | 1 | NOT NULL | True=バックオフィス依頼必要 |
| D-011 | エスカレーション理由 | escalation_reason | text | - | NULLABLE | 判定不可となった要因の記録 |
| D-012 | バックオフィス回答案 | bo_response_text | text | - | NULLABLE | バックオフィスが作成した回答 |
| D-013 | 最終回答文 | final_response_text | text | - | NOT NULL | 顧客へ送付する確定文面 |
| D-014 | 監査ログID | audit_log_id | string | 36 | NOT NULL | 送信ログと紐づく監査レコードID |

---

## 5. ER図・テーブル定義（必要に応じて）
PoC フェーズでは既存 CRM／ログ基盤にリレーションを追加する。正式リリース時には問い合わせテーブル（Inquiry）、帳票メタテーブル（ReportMeta）、AI出力テーブル（AiResponse）、エスカレーションテーブル（Escalation）の ER 図および PK/FK 定義を別紙で提示する。

